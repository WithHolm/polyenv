name: Main - Release
on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        type: choice
        required: true
        default: 'patch'
        options:
          - none
          - patch
          - minor
          - major
      release_candiate:
        description: 'Release candidate'
        type: boolean
        required: false
        default: false
      commit:
        description: 'commit to the release. updates changelog and tags'
        type: boolean
        required: false
        default: false

env:
  goreleaser_version: ~> v2
  goreleaser_dist: goreleaser

permissions:
  contents: write

jobs:
  build:
    name: build
    runs-on: ubuntu-latest
    steps:
      - name: Check for correct repository
        if: ${{ github.event_name != 'workflow_dispatch' && github.repository != 'withholm/polyenv' }}
        run: |
          echo "Should only run in the withholm/polyenv repository"
          exit 1

      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          cache: true
      
      - name: get latest tag that is v.*.*
        id: get-latest-tag
        run: |
          latest_tag=$(git tag --sort="v:refname" | tail -1)
          echo "Found latest tag: $latest_tag"
          echo "tag=$latest_tag" >> $GITHUB_OUTPUT
      
      - name: Bump base version
        id: bump_base_version
        run: |
          current_version=${{ steps.get-latest-tag.outputs.tag }}
          current_version_no_v=${current_version#v}

          base_version=$(echo $current_version_no_v | cut -d'-' -f1)
          pre_release_part=$(echo $current_version_no_v | grep -o -- '-.*' || true)

          IFS='.' read -r -a version_parts <<< "$base_version"
          major=${version_parts[0]}
          minor=${version_parts[1]}
          patch=${version_parts[2]}

          case "${{ github.event.inputs.version_bump }}" in
            major)
              major=$((major + 1)); minor=0; patch=0
              ;;
            minor)
              minor=$((minor + 1)); patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac

          new_base_version="$major.$minor.$patch"

          echo "new_base_version=$new_base_version" >> $GITHUB_OUTPUT
          echo "base_version=$base_version" >> $GITHUB_OUTPUT
          echo "pre_release_part=$pre_release_part" >> $GITHUB_OUTPUT

      - name: Handle RC version
        id: bump_version
        run: |
          new_base_version="${{ steps.bump_base_version.outputs.new_base_version }}"
          base_version="${{ steps.bump_base_version.outputs.base_version }}"
          pre_release_part="${{ steps.bump_base_version.outputs.pre_release_part }}"

          if [[ "${{ github.event.inputs.release_candiate }}" == "true" ]]; then
            if [[ -z "$pre_release_part" ]] || [[ "$base_version" != "$new_base_version" ]]; then
              new_version="$new_base_version-rc.1"
            else
              rc_number=$(echo $pre_release_part | grep -o '[0-9]*$')
              new_rc_number=$((rc_number + 1))
              new_version="$new_base_version-rc.$new_rc_number"
            fi
          else
            if [[ -n "$pre_release_part" ]] && [[ "${{ github.event.inputs.version_bump }}" == "none" ]]; then
              new_version="$base_version"
            else
              new_version="$new_base_version"
            fi
          fi

          new_version="v$new_version"

          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          echo "${{ steps.get-latest-tag.outputs.tag }} -> $new_version"

      - name: go actions
        run: |
          go mod tidy
          go mod download
          go mod vendor

      - name: Grab changelog md from current
        id: changelog
        uses: ./.github/actions/collect-changelog
  
      - name: generate changelog md
        id: generate-changelog
        run: |
          echo "${{ steps.changelog.outputs.data }}" > changelog.md

      - name: Commit and tag for goreleaser
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git commit -m "chore(release): update for ${{ steps.bump_version.outputs.new_version }}"
          git tag ${{ steps.bump_version.outputs.new_version }} -f

      - name: Build and release
        id: goreleaser
        uses: goreleaser/goreleaser-action@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CI: true
        with:
          version: "~> v2"
          distribution: goreleaser
          args: release --clean --draft --release-notes changelog.md